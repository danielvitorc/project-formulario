{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://encrypted-tbn2.gstatic.com/faviconV2?url=https://www.nortetech.net&client=VFE&size=64&type=FAVICON&fallback_opts=TYPE,SIZE,URL&nfrp=2" type="image/png">
    <title>{% block title %}Formulário SESMT - {{ chamado.nome_colaborador }}{% endblock %}</title>

    <link rel="stylesheet" href="{% static 'css/sesmt_style.css' %}">
    <!-- Adicionar link para uma biblioteca de ícones, como Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos herdados de sesmt_style.css e ajustes específicos */
        #aso_documento_div,
        #epi_documento_div,
        #nr10_documento_div,
        #sep_documento_div,
        #nr35_documento_div {
            display: none;
        }

        body {
            display: flex;
            justify-content: center; /* Centraliza o container principal */
            align-items: flex-start; /* Alinha ao topo para permitir scroll */
            padding-top: 40px; /* Espaço no topo */
            padding-bottom: 40px; /* Espaço na base */
        }
        body::-webkit-scrollbar {
            width: 10px;
        }

        body::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 10px;
        }

        body::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #004aad, #0066ff);
            border-radius: 10px;
            border: 2px solid #f0f0f0;
        }

        body::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #0030a0, #004aad);
        }
        .container-forme {
            background: linear-gradient(135deg, var(--bg-color) 0%, #e0e0e0 100%);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.42);
            width: 100%;
            max-width: 900px;
            }

        .form-container {
            background-color: var(--card-bg);
            padding: 35px 40px; /* Aumenta o padding */
            border-radius: 12px; /* Bordas mais suaves */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); /* Sombra mais pronunciada */
            width: 100%;
            max-width: 750px; /* Largura ajustada */
            margin: 20px auto 0 auto; /* Centraliza horizontalmente, mantém margem superior de 20px */
            border-top: 5px solid var(--primary-color); /* Detalhe de cor no topo */
        }

        .form-container h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px; /* Mais espaço abaixo do título */
            font-size: 2em; /* Título maior */
        }

        .form-field-group {
            margin-bottom: 25px; /* Espaçamento entre grupos de campos */
            position: relative; /* Para posicionamento de ícones */
        }

        .form-field-group label {
            display: block;
            margin-bottom: 10px; /* Mais espaço abaixo do label */
            font-weight: 600; /* Fonte um pouco mais forte */
            color: var(--text-color);
            font-size: 0.95em;
        }

        .form-field-group input[type="text"],
        .form-field-group input[type="email"],
        .form-field-group input[type="date"],
        .form-field-group input[type="file"],
        .form-field-group select,
        .form-field-group textarea {
            width: 100%; /* Ocupa toda a largura disponível */
            padding: 14px 20px; /* Padding interno maior */
            padding-left: 45px; /* Espaço para o ícone */
            border: 1px solid var(--secondary-color);
            border-radius: 8px; /* Bordas mais arredondadas */
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box;
            background-color: #f9f9f9; /* Fundo levemente diferente */
        }
        
        .form-field-group input[type="file"] {
            padding-left: 14px; /* Arquivos não precisam de ícone interno da mesma forma */
        }

        .form-field-group input[type="text"]:focus,
        .form-field-group input[type="email"]:focus,
        .form-field-group input[type="date"]:focus,
        .form-field-group input[type="file"]:focus,
        .form-field-group select:focus,
        .form-field-group textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 8px rgba(19, 75, 242, 0.35); /* Sombra de foco mais suave */
            background-color: #fff;
        }
        
        .form-field-group .input-icon {
            position: absolute;
            left: 15px;
            top: calc(50% + 5px); /* Ajuste para alinhar com o input */
            transform: translateY(-50%);
            color: var(--secondary-color);
            font-size: 1.1em;
            pointer-events: none; /* Para não interferir com o clique no input */
        }

        .form-field-group input:focus + .input-icon,
        .form-field-group textarea:focus + .input-icon, /* Embora textarea não tenha ícone por padrão aqui */
        .form-field-group select:focus + .input-icon { /* Selects são mais complicados para ícones internos assim */
            color: var(--primary-color);
        }
        
        .form-field-group input[type="checkbox"] {
            margin-right: 10px;
            vertical-align: middle;
            width: auto; /* Checkbox não ocupa 100% */
            height: 1.2em; /* Tamanho do checkbox */
            accent-color: var(--primary-color); /* Cor do checkbox quando marcado */
        }
        
        .checkbox-label {
            display: inline-flex; /* Para alinhar checkbox e texto */
            align-items: center;
            font-weight: normal;
            color: var(--text-color);
        }

        .form-field-group .helptext {
            font-size: 0.85em;
            color: var(--secondary-color);
            margin-top: 8px;
            display: block;
            padding-left: 5px; /* Pequeno recuo */
        }

        .form-actions {
            text-align: center;
            margin-top: 40px; /* Mais espaço acima dos botões */
        }

        button[type="submit"] {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 35px; /* Botão maior */
            border: none;
            border-radius: 8px; /* Bordas mais suaves */
            font-size: 1.15em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        button[type="submit"]:hover {
            background-color: var(--accent-color);
            transform: translateY(-3px); /* Efeito de elevação maior */
            box-shadow: 0 6px 15px rgba(12, 135, 242, 0.4); /* Sombra no hover */
        }

        hr {
            border: none;
            height: 1px;
            background-color: var(--border-color, #d0d0d0); /* Usa variável de sesmt_style.css ou fallback */
            margin-top: 30px;
            margin-bottom: 30px;
        }

        /* Estilização para input[type="file"] customizado */
        .form-field-group input[type="file"].custom-file-input-hidden {
            display: none; /* Esconde o input original via JS adicionando esta classe */
        }

        .custom-file-upload-button { /* Botão customizado que aciona o input[type="file"] */
            display: inline-flex; /* Para alinhar ícone e texto */
            align-items: center;
            justify-content: center; /* Centraliza conteúdo (ícone e texto) */
            padding: 12px 20px;
            background-color: var(--secondary-color);
            color: var(--text-on-primary, #ffffff); /* Garanta que text-on-primary esteja definido ou use #fff */
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            font-weight: 500;
            font-size: 0.95em;
            border: none; /* Remove borda padrão */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Sombra sutil */
        }

        .custom-file-upload-button:hover {
            background-color: var(--primary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* Sombra mais pronunciada no hover */
        }

        .custom-file-upload-button .input-icon { /* Ícone dentro do botão */
            margin-right: 10px;
            font-size: 1.1em;
        }

        .file-name-display { /* Para mostrar o nome do arquivo selecionado */
            display: block;
            margin-top: 10px; /* Espaço acima do nome do arquivo */
            font-size: 0.9em;
            color: var(--text-color);
            padding: 10px 12px;
            background-color: #f8f9fa; /* Fundo sutil, como um campo desabilitado */
            border: 1px dashed var(--border-color, #ced4da); /* Borda tracejada para indicar área de info */
            border-radius: 6px;
            min-height: 22px;
            line-height: 1.5;
            text-align: left;
            font-style: italic;
            word-break: break-all; /* Para nomes de arquivo longos não quebrarem o layout */
        }
        
        /* Classe para o label original do Django quando for de um campo de arquivo */
        .form-field-group > label.is-file-field-label {
            margin-bottom: 15px; /* Aumenta o espaço entre o label e o botão de upload */
        }

        /* Estilização para Radio Buttons e seus Labels */
        .form-field-group.radio-group {
            /* padding-left: 5px; Adiciona um leve recuo se necessário */
        }

        .form-field-group.radio-group > label { /* Label principal do grupo de radios */
            margin-bottom: 12px; /* Espaço entre o label do grupo e as opções */
            font-weight: 600;
        }

        .radio-option {
            display: flex; /* Alinha o rádio customizado e o texto do label */
            align-items: center;
            margin-bottom: 10px; /* Espaço entre as opções de rádio */
            cursor: pointer;
            position: relative;
        }

        .radio-option input[type="radio"] {
            opacity: 0; /* Esconde o rádio original */
            position: absolute;
            width: 1px;
            height: 1px;
        }

        .radio-custom-indicator {
            width: 20px;
            height: 20px;
            border: 2px solid var(--secondary-color);
            border-radius: 50%;
            margin-right: 12px;
            display: inline-block;
            position: relative;
            transition: border-color 0.3s ease;
        }

        .radio-option:hover .radio-custom-indicator {
            border-color: var(--primary-color);
        }

        .radio-option input[type="radio"]:checked + .radio-custom-indicator {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
        }

        .radio-option input[type="radio"]:checked + .radio-custom-indicator::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            transform: translate(-50%, -50%);
        }
        
        .radio-option input[type="radio"]:focus + .radio-custom-indicator {
             box-shadow: 0 0 0 3px rgba(19, 75, 242, 0.25); /* Foco similar a outros inputs */
        }

        .radio-label-text {
            font-weight: normal;
            color: var(--text-color);
            font-size: 0.95em;
        }
        
        /* Ajuste para Textarea com ícone */
        .form-field-group textarea + .input-icon {
            top: 22px; /* Ajusta a posição vertical do ícone para textareas */
            transform: none;
        }


        /* Estilizando a renderização {{ form.as_p }} do Django */
        form > p { /* Seleciona os <p> diretamente dentro do <form> */
            margin-bottom: 0; /* Remove margem padrão, será controlada por .form-field-group */
        }

    </style>
</head>
<body>
    <div id="notification" style="display:none; position: fixed; top: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 15px 25px; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); font-weight: bold; z-index: 9999;">
        Formulário salvo com sucesso!
    </div>

    <div class="container-forme">
        <div class="form-container">
            <h2><i class="fas fa-clipboard-list" style="margin-right: 10px; color: var(--primary-color);"></i>Formulário SESMT: {{ chamado.nome_colaborador }}</h2>
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- ASO -->
                <div>
                    {{ form.aso.label_tag }}
                    {{ form.aso }}
                </div>
                <div id="aso_documento_div">
                    <label>Documento ASO:</label>
                    {{ form.aso_documento }}
                </div>
                <div>
                    <label>Descrição ASO:</label>
                    {{ form.aso_descricao }}
                </div>

                <hr>

                <!-- EPI/EPC -->
                <div>
                    {{ form.epi_epc.label_tag }}
                    {{ form.epi_epc }}
                </div>
                <div id="epi_documento_div">
                    <label>Documento EPI/EPC:</label>
                    {{ form.epi_epc_documento }}
                </div>
                <div>
                    <label>Descrição EPI/EPC:</label>
                    {{ form.epi_epc_descricao }}
                </div>

                <hr>

                <!-- NR10 -->
                <div>
                    {{ form.curso_nr10.label_tag }}
                    {{ form.curso_nr10 }}
                </div>
                <div id="nr10_documento_div">
                    <label>Documento NR10:</label>
                    {{ form.curso_nr10_documento }}
                </div>

                <hr>

                <!-- SEP -->
                <div>
                    {{ form.curso_sep.label_tag }}
                    {{ form.curso_sep }}
                </div>
                <div id="sep_documento_div">
                    <label>Documento SEP:</label>
                    {{ form.curso_sep_documento }}
                </div>

                <hr>

                <!-- NR35 -->
                <div>
                    {{ form.curso_nr35.label_tag }}
                    {{ form.curso_nr35 }}
                </div>
                <div id="nr35_documento_div">
                    <label>Documento NR35:</label>
                    {{ form.curso_nr35_documento }}
                </div>

                <div>
                    {{ form.cursos_observacoes.label_tag }}
                    {{ form.cursos_observacoes }}
                </div>

                <div>
                    {{ form.data_autorizacao_sesmt.label_tag }}
                    {{ form.data_autorizacao_sesmt }}
                </div>

                <div>
                    {{ form.nome_sesmt.label_tag }}
                    {{ form.nome_sesmt }}
                </div>

                <div>
                    {{ form.assinar_como_sesmt }}
                    {{ form.assinar_como_sesmt.label_tag }}
                    <br>
                    <small>{{ form.assinar_como_sesmt.help_text }}</small>

                </div>
                

                <div class="form-actions">
                    <button type="submit">
                        <i class="fas fa-save" style="margin-right: 8px;"></i>Salvar Alterações
                    </button>
                </div>


            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            if (!form) return;

            const notification = document.getElementById('notification');

            form.addEventListener('submit', function(event) {
                // Exibe a notificação
                if (notification) {
                    notification.style.display = 'block';
                }

                // Define um timeout para fechar a aba após 3 segundos
                setTimeout(function() {
                    // Tenta fechar a aba. Isso pode não funcionar em todos os navegadores
                    // ou se a aba não foi aberta por um script.
                    window.close();
                }, 8000);

                // Não previna o envio padrão do formulário, a menos que haja validação AJAX
                // event.preventDefault(); // Removido ou comentado se o envio padrão for desejado
            });

            // Envolve cada campo gerado pelo Django (que está em um <p>) em uma div .form-field-group
            // e adiciona ícones com base no tipo de input.
            const formParagraphs = form.querySelectorAll('p');

            formParagraphs.forEach(p => {
                const label = p.querySelector('label'); // Label principal do campo
                const inputs = p.querySelectorAll('input, select, textarea'); // Todos os inputs dentro do <p>
                const helpText = p.querySelector('.helptext');
                
                // Cria o wrapper
                const fieldGroup = document.createElement('div');
                fieldGroup.classList.add('form-field-group');

                // Move o label para dentro do fieldGroup
                if (label) {
                    fieldGroup.appendChild(label);
                }

                inputs.forEach((input, index) => {
                    // Adiciona classes de controle, exceto para radios que terão tratamento especial
                    if (input.type !== 'radio') {
                        input.classList.add('form-control');
                    }
                    
                    let iconClass = '';
                    const inputType = input.getAttribute('type');
                    const inputName = input.getAttribute('name');

                    if (inputType === 'radio') {
                        fieldGroup.classList.add('radio-group');
                        // O label principal (p.querySelector('label')) já foi adicionado ao fieldGroup.
                        // Agora processamos cada input de rádio e seu label específico.
                        const radioId = input.id;
                        // Tentamos encontrar um label que seja especificamente para este radio input.
                        let radioSpecificLabel = form.querySelector(`label[for="${radioId}"]`);
                        
                        const optionWrapper = document.createElement('div');
                        optionWrapper.classList.add('radio-option');

                        const customIndicator = document.createElement('span');
                        customIndicator.classList.add('radio-custom-indicator');
                        
                        optionWrapper.appendChild(input); // Move o input original para dentro
                        optionWrapper.appendChild(customIndicator);

                        if (radioSpecificLabel && radioSpecificLabel !== label) {
                            const labelTextSpan = document.createElement('span');
                            labelTextSpan.classList.add('radio-label-text');
                            labelTextSpan.textContent = radioSpecificLabel.textContent;
                            optionWrapper.appendChild(labelTextSpan);
                            radioSpecificLabel.remove();
                        } else if (!radioSpecificLabel && input.nextSibling && input.nextSibling.nodeType === Node.TEXT_NODE && input.nextSibling.textContent.trim()) {
                            const labelTextSpan = document.createElement('span');
                            labelTextSpan.classList.add('radio-label-text');
                            labelTextSpan.textContent = input.nextSibling.textContent.trim();
                            optionWrapper.appendChild(labelTextSpan);
                            input.nextSibling.remove();
                        }
                        fieldGroup.appendChild(optionWrapper);

                    } else if (input.tagName.toLowerCase() === 'select') {
                        iconClass = 'fas fa-chevron-down';
                        fieldGroup.appendChild(input);
                    } else if (input.tagName.toLowerCase() === 'textarea') {
                        iconClass = 'fas fa-edit';
                        fieldGroup.appendChild(input);
                    } else {
                        if(inputType !== 'file') {
                           fieldGroup.appendChild(input);
                        }
                        switch (inputType) {
                            case 'text':
                                if (inputName && inputName.toLowerCase().includes('nome')) iconClass = 'fas fa-user';
                                else if (inputName && inputName.toLowerCase().includes('cargo')) iconClass = 'fas fa-briefcase';
                                else if (inputName && inputName.toLowerCase().includes('setor')) iconClass = 'fas fa-building';
                                else iconClass = 'fas fa-pencil-alt';
                                break;
                            case 'email':
                                iconClass = 'fas fa-envelope';
                                break;
                            case 'date':
                                iconClass = 'fas fa-calendar-alt';
                                break;
                            case 'file':
                                // Não define iconClass aqui, pois o tratamento será diferente
                                if (label) {
                                    label.classList.add('is-file-field-label'); // Adiciona classe ao label original
                                }
                                input.classList.add('custom-file-input-hidden'); // Esconde o input original

                                // Cria o botão de upload customizado
                                const uploadButton = document.createElement('button');
                                uploadButton.setAttribute('type', 'button'); // Importante para não submeter o form
                                uploadButton.classList.add('custom-file-upload-button');
                                
                                const buttonIcon = document.createElement('span');
                                buttonIcon.className = 'input-icon fas fa-cloud-upload-alt'; // Ícone para o botão
                                uploadButton.appendChild(buttonIcon);
                                
                                const buttonText = document.createTextNode(' Escolher Arquivo');
                                uploadButton.appendChild(buttonText);

                                // Cria o display para o nome do arquivo
                                const fileNameDisplay = document.createElement('div');
                                fileNameDisplay.classList.add('file-name-display');
                                fileNameDisplay.textContent = 'Nenhum arquivo selecionado';

                                // Adiciona o botão e o display ao fieldGroup ANTES do input escondido
                                fieldGroup.appendChild(uploadButton);
                                fieldGroup.appendChild(fileNameDisplay);
                                
                                // Event listener para o botão customizado
                                uploadButton.addEventListener('click', () => {
                                    input.click(); // Aciona o clique no input original escondido
                                });

                                // Event listener para o input original (quando um arquivo é selecionado)
                                input.addEventListener('change', () => {
                                    if (input.files && input.files.length > 0) {
                                        fileNameDisplay.textContent = input.files[0].name;
                                    } else {
                                        fileNameDisplay.textContent = 'Nenhum arquivo selecionado';
                                    }
                                });
                                break;
                            case 'checkbox':
                                const checkId = input.id;
                                const checkSpecificLabel = form.querySelector(`label[for="${checkId}"]`);
                                input.classList.add('form-check-input');
                                
                                const checkboxOptionWrapper = document.createElement('div');
                                checkboxOptionWrapper.classList.add('checkbox-option');
                                checkboxOptionWrapper.style.display = 'flex';
                                checkboxOptionWrapper.style.alignItems = 'center';
                                checkboxOptionWrapper.style.marginBottom = '10px';
                                
                                if(input.parentNode === fieldGroup) fieldGroup.removeChild(input);
                                checkboxOptionWrapper.appendChild(input);

                                if (checkSpecificLabel && checkSpecificLabel !== label) {
                                    const checkLabelTextSpan = document.createElement('span');
                                    checkLabelTextSpan.classList.add('checkbox-label-text');
                                    checkLabelTextSpan.textContent = checkSpecificLabel.textContent;
                                    checkLabelTextSpan.style.marginLeft = '8px';
                                    checkboxOptionWrapper.appendChild(checkLabelTextSpan);
                                    checkSpecificLabel.remove();
                                } else if (!checkSpecificLabel && input.nextSibling && input.nextSibling.nodeType === Node.TEXT_NODE && input.nextSibling.textContent.trim()) {
                                    const checkLabelTextSpan = document.createElement('span');
                                    checkLabelTextSpan.classList.add('checkbox-label-text');
                                    checkLabelTextSpan.textContent = input.nextSibling.textContent.trim();
                                    checkLabelTextSpan.style.marginLeft = '8px';
                                    checkboxOptionWrapper.appendChild(checkLabelTextSpan);
                                    input.nextSibling.remove();
                                }
                                fieldGroup.appendChild(checkboxOptionWrapper);
                                break;
                            default:
                                if (inputType !== 'file') { // Ícone padrão para outros tipos, exceto file
                                   iconClass = 'fas fa-pencil-alt'; // Ou um ícone mais genérico como 'fas fa-edit'
                                }
                        }
                    }
                    
                    if (iconClass && inputType !== 'file' && inputType !== 'checkbox' && inputType !== 'radio') {
                        const iconSpan = document.createElement('span');
                        iconSpan.className = `input-icon ${iconClass}`;
                        fieldGroup.appendChild(iconSpan);
                    }
                });
                
                // Move o helptext para dentro do fieldGroup
                if (helpText) {
                    fieldGroup.appendChild(helpText);
                }
                
                // Substitui o <p> original pelo novo fieldGroup
                p.parentNode.replaceChild(fieldGroup, p);
            });

            // Função auxiliar para estilizar campos individuais que não estão em <p>
            function styleIndividualField(form, fieldId, iconClassDefault) {
                const inputElement = form.querySelector(`#${fieldId}`);
                if (!inputElement) return;

                const labelElement = form.querySelector(`label[for="${fieldId}"]`);
                // Encontra o DIV pai mais próximo que contém diretamente o label e o input
                // Isso é um pouco heurístico; pode precisar de ajuste se a estrutura for complexa.
                let parentDiv = inputElement.closest('div');
                if (labelElement && labelElement.parentNode !== parentDiv) {
                    parentDiv = labelElement.closest('div');
                }
                // Se o label e o input estão em divs diferentes, mas um é pai do outro, usa o mais externo.
                if (labelElement && parentDiv && !parentDiv.contains(labelElement)){
                    parentDiv = form; // Fallback para o form se não encontrar um pai comum adequado
                }


                if (!parentDiv || (labelElement && !parentDiv.contains(labelElement)) || !parentDiv.contains(inputElement)) {
                    // Se não encontrar um div pai comum claro, ou se o label/input não estiver nele,
                    // vamos criar o fieldGroup e adicionar os elementos individualmente,
                    // e tentar substituir o input ou o label no DOM.
                    console.warn(`Não foi possível encontrar um DIV pai comum claro para ${fieldId}. Tentando estilização individual.`);
                    
                    const fieldGroup = document.createElement('div');
                    fieldGroup.classList.add('form-field-group');

                    if (labelElement) {
                        fieldGroup.appendChild(labelElement.cloneNode(true)); // Clona para não remover do lugar errado
                    }
                    
                    const clonedInput = inputElement.cloneNode(true);
                    clonedInput.classList.add('form-control');
                    fieldGroup.appendChild(clonedInput);
                    
                    let iconClass = iconClassDefault;
                    const inputType = clonedInput.getAttribute('type');
                    const inputName = clonedInput.getAttribute('name');

                    if (clonedInput.tagName.toLowerCase() === 'select') {
                        iconClass = 'fas fa-chevron-down';
                    } else if (clonedInput.tagName.toLowerCase() === 'textarea') {
                        iconClass = 'fas fa-edit';
                    } else if (inputType === 'file') {
                        // A lógica de arquivo customizado já deve ter sido aplicada se o input foi pego pelo querySelectorAll('input, select, textarea')
                        // Mas se este input de arquivo foi renderizado fora de um <p>, precisamos aplicar aqui.
                        // Esta parte pode precisar de refatoração para não duplicar a lógica de customização de arquivo.
                        // Por ora, vamos apenas adicionar o ícone se não for tratado como custom file.
                        if (!clonedInput.classList.contains('custom-file-input-hidden')) {
                             iconClass = 'fas fa-file-upload';
                        } else {
                            iconClass = ''; // Já tratado
                        }
                    } else {
                         switch (inputType) {
                            case 'text':
                                if (inputName && inputName.toLowerCase().includes('nome')) iconClass = 'fas fa-user';
                                else iconClass = 'fas fa-pencil-alt';
                                break;
                            case 'date':
                                iconClass = 'fas fa-calendar-alt';
                                break;
                            default:
                                iconClass = iconClassDefault || 'fas fa-edit';
                        }
                    }

                    if (iconClass && inputType !== 'file') { // Não adiciona ícone aqui para 'file' se for o customizado
                        const iconSpan = document.createElement('span');
                        iconSpan.className = `input-icon ${iconClass}`;
                        fieldGroup.appendChild(iconSpan);
                    }
                    
                    // Substitui o input original pelo fieldGroup. O label original pode ficar órfão ou ser removido se clonado.
                    if (inputElement.parentNode) {
                        inputElement.parentNode.replaceChild(fieldGroup, inputElement);
                        if (labelElement && labelElement.parentNode && labelElement.parentNode !== fieldGroup) {
                           // Se o label original não foi movido e está em outro lugar, remove-o para evitar duplicidade.
                           // Isso é arriscado se o label não foi clonado. Melhor garantir que o label original seja movido ou clonado.
                           // A heurística acima para parentDiv tenta evitar isso.
                        }
                    }
                     // Se o label original ainda existir e não for o que está no fieldGroup, remove-o
                    const originalLabelStillThere = form.querySelector(`label[for="${fieldId}"]`);
                    if (originalLabelStillThere && originalLabelStillThere !== fieldGroup.querySelector(`label[for="${fieldId}"]`)) {
                        originalLabelStillThere.remove();
                    }

                    return; // Sai da função após tentativa de estilização individual
                }


                const fieldGroup = document.createElement('div');
                fieldGroup.classList.add('form-field-group');

                if (labelElement) {
                    fieldGroup.appendChild(labelElement); // Move o label original
                }
                
                inputElement.classList.add('form-control');
                fieldGroup.appendChild(inputElement); // Move o input original
                
                let iconClass = iconClassDefault;
                const inputType = inputElement.getAttribute('type');
                const inputName = inputElement.getAttribute('name');

                if (inputElement.tagName.toLowerCase() === 'select') {
                    iconClass = 'fas fa-chevron-down';
                } else if (inputElement.tagName.toLowerCase() === 'textarea') {
                    iconClass = 'fas fa-edit';
                } else if (inputType === 'file') {
                     // Se for um input de arquivo que não foi pego pela lógica de customização de arquivos (em <p>)
                    if (!inputElement.classList.contains('custom-file-input-hidden')) {
                        // Aplica a lógica de customização de arquivo aqui
                        inputElement.classList.add('custom-file-input-hidden');
                        if (labelElement) labelElement.classList.add('is-file-field-label');

                        const uploadButton = document.createElement('button');
                        uploadButton.setAttribute('type', 'button');
                        uploadButton.classList.add('custom-file-upload-button');
                        const buttonIconSpan = document.createElement('span');
                        buttonIconSpan.className = 'input-icon fas fa-cloud-upload-alt';
                        uploadButton.appendChild(buttonIconSpan);
                        uploadButton.appendChild(document.createTextNode(' Escolher Arquivo'));

                        const fileNameDisplay = document.createElement('div');
                        fileNameDisplay.classList.add('file-name-display');
                        fileNameDisplay.textContent = 'Nenhum arquivo selecionado';

                        // Insere o botão e o display ANTES do input escondido, dentro do fieldGroup
                        fieldGroup.insertBefore(uploadButton, inputElement);
                        fieldGroup.insertBefore(fileNameDisplay, inputElement);
                        
                        uploadButton.addEventListener('click', () => inputElement.click());
                        inputElement.addEventListener('change', () => {
                            fileNameDisplay.textContent = inputElement.files && inputElement.files.length > 0 ? inputElement.files[0].name : 'Nenhum arquivo selecionado';
                        });
                        iconClass = ''; // Ícone já está no botão
                    } else {
                         iconClass = ''; // Já tratado pela lógica de <p>
                    }
                } else {
                     switch (inputType) {
                        case 'text':
                            if (inputName && inputName.toLowerCase().includes('nome')) iconClass = 'fas fa-user';
                            else iconClass = 'fas fa-pencil-alt';
                            break;
                        case 'date':
                            iconClass = 'fas fa-calendar-alt';
                            break;
                        default:
                            iconClass = iconClassDefault || 'fas fa-edit';
                    }
                }

                if (iconClass) {
                    const iconSpan = document.createElement('span');
                    iconSpan.className = `input-icon ${iconClass}`;
                    // Adiciona o ícone após o input, mas antes de outros elementos se houver
                    if (inputElement.nextSibling) {
                        fieldGroup.insertBefore(iconSpan, inputElement.nextSibling);
                    } else {
                        fieldGroup.appendChild(iconSpan);
                    }
                }
                
                if (parentDiv && parentDiv !== form) { // Se encontramos um div pai específico
                    parentDiv.parentNode.replaceChild(fieldGroup, parentDiv);
                } else { // Se não, tentamos substituir o input original (ou o label se o input não tiver pai)
                    if (inputElement.parentNode) {
                         inputElement.parentNode.replaceChild(fieldGroup, inputElement);
                    } else if (labelElement && labelElement.parentNode) {
                        labelElement.parentNode.replaceChild(fieldGroup, labelElement);
                    }
                }
            }

            // Estiliza os campos que não estão em <p>
            // Os IDs são baseados na convenção do Django: id_<field_name>
            styleIndividualField(form, 'id_data_autorizacao_sesmt', 'fas fa-calendar-alt');
            styleIndividualField(form, 'id_nome_sesmt', 'fas fa-user');
            styleIndividualField(form, 'id_assinatura_sesmt', 'fas fa-file-signature'); // Este é um campo de arquivo

            // Adiciona animação suave ao focar nos inputs
            const allInputs = form.querySelectorAll('.form-control');
            allInputs.forEach(input => {
                input.addEventListener('focus', () => {
                    input.style.transform = 'scale(1.01)';
                });
                input.addEventListener('blur', () => {
                    input.style.transform = 'scale(1)';
                });
            });
        });
    </script>

    <script>
    function toggleDocumento(radioName, divId) {
        const radios = document.getElementsByName(radioName);
        radios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.checked && radio.value === 'Apto') {
                    document.getElementById(divId).style.display = 'block';
                } else if (radio.checked) {
                    document.getElementById(divId).style.display = 'none';
                    const fileInput = document.querySelector(`#${divId} input[type="file"]`);
                    if (fileInput) {
                        fileInput.value = ''; // Limpa o valor do input de arquivo
                        // Dispara o evento 'change' para atualizar o display do nome do arquivo, se houver
                        const changeEvent = new Event('change', { bubbles: true });
                        fileInput.dispatchEvent(changeEvent);
                    }
                }
            });
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Garante que o script de manipulação de formulário (ícones, etc.) já rodou
        // e os inputs de arquivo já foram processados e têm seus botões e displays.

        toggleDocumento('aso', 'aso_documento_div');
        toggleDocumento('epi_epc', 'epi_documento_div');
        toggleDocumento('curso_nr10', 'nr10_documento_div');
        toggleDocumento('curso_sep', 'sep_documento_div');
        toggleDocumento('curso_nr35', 'nr35_documento_div');

        // Atualiza estado inicial dos campos de documento condicional
        // É importante que isso rode depois que os inputs de arquivo foram customizados
        // para que a lógica de limpar o file input e seu display funcione corretamente.
        const radiosForToggle = ['aso', 'epi_epc', 'curso_nr10', 'curso_sep', 'curso_nr35'];
        radiosForToggle.forEach(radioName => {
            const checkedRadio = document.querySelector(`input[name="${radioName}"]:checked`);
            if (checkedRadio) {
                // Simula um evento de change para garantir que a visibilidade e o estado do input de arquivo sejam definidos corretamente
                const changeEvent = new Event('change', { bubbles: true });
                checkedRadio.dispatchEvent(changeEvent);
            } else {
                // Se nenhum rádio estiver marcado para um grupo, esconde o div do documento correspondente
                let divIdToHide = '';
                if (radioName === 'aso') divIdToHide = 'aso_documento_div';
                else if (radioName === 'epi_epc') divIdToHide = 'epi_documento_div';
                else if (radioName === 'curso_nr10') divIdToHide = 'nr10_documento_div';
                else if (radioName === 'curso_sep') divIdToHide = 'sep_documento_div';
                else if (radioName === 'curso_nr35') divIdToHide = 'nr35_documento_div';

                if (divIdToHide) {
                    const divElement = document.getElementById(divIdToHide);
                    if (divElement) {
                        divElement.style.display = 'none';
                        const fileInput = divElement.querySelector(`input[type="file"]`);
                        if (fileInput) {
                            fileInput.value = '';
                            const fileChangeEvent = new Event('change', { bubbles: true });
                            fileInput.dispatchEvent(fileChangeEvent);
                        }
                    }
                }
            }
        });
    });
    </script>

</body>
</html>
